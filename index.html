<!DOCTYPE html>
<html lang="en">

<head>
    <title>Leed Price Calculator</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<script>
    function print_country(country_id) {
        // given the id of the <select> tag as function argument, it inserts <option> tags
        $("#country-icon").replaceWith("<i id=\"country-icon-dynamic\" class=\"fa fa-refresh fa-pulse\"></i>");
        $.getJSON('https://leedonline-api.usgbc.org/v1/Common/getCountriesAndStates.json', function (data) {
            var option_str = document.getElementById(country_id);
            option_str.length = 0;
            option_str.options[0] = new Option('Select Country', '');
            option_str.selectedIndex = 0;
            var countries = data.countries;
            var printCountries = Object.keys(countries);
            printCountries.forEach(function (key) {
                option_str.options[option_str.length] = new Option(countries[key], key);
            });
            $("#country-icon-dynamic").replaceWith("<i id=\"country-icon\" class=\"fa fa-globe\"></i>");
        });
    }

    $(document).ready(function () {
        $("#leedprice").submit(function () {
            $("#submit-calculate").replaceWith("<button id=\"submit-dynamic\" class=\"btn btn-success\"><i class=\"fa fa-spinner fa-pulse\"></i> Calculating</button>");
            var country = $("#country").val();
            var state = $("#state").val();
            var ratingSystem = $("#ratingSystem").val();
            var type = $('#type').val();
            var givenArea = $('#givenArea').val();
            $.getJSON('https://leedonline-api.usgbc.org/v1/Common/getPriceRelatedInfo.json?countryOrCurrency=' + country, function (infodata) {
                var currency = infodata.data.currency;
                $.getJSON('https://leedonline-api.usgbc.org/v1/LEEDPricing/getVersionPricesInfo.json?versionOrCurrency=' + currency + '&ratingSystem=' + ratingSystem + '&area=' + givenArea + '&calculate=' + type, function (pricedata) {
                    // console.log(pricedata.payableInfo.member.taxes.all.taxes.length);
                    createTotalPriceTable(infodata, pricedata);
                    createTaxTable(infodata, pricedata);
                    createGrandTotal(infodata, pricedata);
                    $("#submit-dynamic").replaceWith("<button id=\"submit-calculate\" class=\"btn btn-primary\" type=\"submit\" name=\"submit\"><i class=\"fa fa-calculator\"></i> Calculate</button>");
                    $("#modalpopup").modal({
                        backdrop: "static"
                    });
                });
            });
        });
        $(".modal-close").click(function () {
            $('#tablebody').empty();
            $("#leedprice").trigger("reset");
        });
    });

    function createTotalPriceTable(infodata, pricedata) {
        var member = pricedata.payableInfo.member;
        var nonMember = pricedata.payableInfo.nonMember;
        var trow = document.createElement("tr");
        var tdrow = document.createElement("th");
        var textnode = document.createTextNode("Total");
        tdrow.appendChild(textnode);
        trow.appendChild(tdrow);
        tdrow = document.createElement("td");
        textnode = document.createTextNode(member.total);
        tdrow.appendChild(textnode);
        trow.appendChild(tdrow);
        tdrow = document.createElement("td");
        textnode = document.createTextNode(nonMember.total);
        tdrow.appendChild(textnode);
        trow.appendChild(tdrow);
        document.getElementById("tablebody").appendChild(trow);
    }

    function createTaxTable(infodata, pricedata) {
        var taxCodes = infodata.data.taxCodes;
        var member = pricedata.payableInfo.member;
        var nonMember = pricedata.payableInfo.nonMember;
        var memTaxObjSize = Object.keys(member.taxes.all.taxes).length;
        if (memTaxObjSize > 0 && memTaxObjSize != "undefined") {
            var taxrow = document.createElement("tr");
            var tdrow = document.createElement("th");
            var textnode = document.createTextNode("Taxes");
            tdrow.appendChild(textnode);
            taxrow.appendChild(tdrow);
            document.getElementById("tablebody").appendChild(taxrow);
            var taxes = Object.keys(member.taxes.all.taxes);
            taxes.forEach(function (key) {
                var taxrow = document.createElement("tr");
                var tdrow = document.createElement("td");
                var textnode = document.createTextNode(taxCodes[key]);
                tdrow.appendChild(textnode);
                taxrow.appendChild(tdrow);
                tdrow = document.createElement("td");
                textnode = document.createTextNode(member.taxes.all.taxes[key]);
                tdrow.appendChild(textnode);
                taxrow.appendChild(tdrow);
                tdrow = document.createElement("td");
                textnode = document.createTextNode(nonMember.taxes.all.taxes[key]);
                tdrow.appendChild(textnode);
                taxrow.appendChild(tdrow);
                document.getElementById("tablebody").appendChild(taxrow);
            });
        }
    }

    function createGrandTotal(infodata, pricedata) {
        var member = pricedata.payableInfo.member;
        var nonMember = pricedata.payableInfo.nonMember;
        var grandTotalrow = document.createElement("tr");
        var tdrow = document.createElement("th");
        var textnode = document.createTextNode("Grand Total");
        tdrow.appendChild(textnode);
        grandTotalrow.appendChild(tdrow);
        tdrow = document.createElement("th");
        textnode = document.createTextNode(member.taxes.all.grandTotal);
        tdrow.appendChild(textnode);
        grandTotalrow.appendChild(tdrow);
        tdrow = document.createElement("th");
        textnode = document.createTextNode(nonMember.taxes.all.grandTotal);
        tdrow.appendChild(textnode);
        grandTotalrow.appendChild(tdrow);
        document.getElementById("tablebody").appendChild(grandTotalrow);
    }
</script>

<body>
    <div class="text-center">
        <h1>LEED PRICING CALCULATOR</h1>
        <br> </div>
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-md-offset-3 col-sm-6 col-sm-offset-3 col-xs-10 col-xs-offset-1">
                <div class="panel panel-primary">
                    <div class="panel-heading"> <strong> Leed Pricing Estimate </strong> </div>
                    <div class="panel-body">
                        <form name="form" id="leedprice" action="javascript:void(0)" role="form">
                            <br>
                            <div class="form-group input-group"> <span class="input-group-addon"><i id="country-icon" class="fa fa-globe"></i></span>
                                <select class="form-control" id="country" name="country" required></select>
                                <script language="javascript">
                                    print_country("country");
                                </script>
                            </div>
                            <div class="form-group input-group"> <span class="input-group-addon"><i class="fa fa-star" aria-hidden="true"></i></span>
                                <input type="text" id="ratingSystem" value="" name="ratingSystem" class="form-control" placeholder="Enter Rating System Group" required> </div>
                            <div class="form-group input-group"> <span class="input-group-addon"><i class="fa fa-file-text" aria-hidden="true"></i></span>
                                <select class="form-control" id="type" name="type" required>
                                    <option value="">Select Type</option>
                                    <option value="rate">Registration</option>
                                    <option value="designRate">Design Review</option>
                                    <option value="constRate">Construction Review</option>
                                </select>
                            </div>
                            <div class="form-group input-group"> <span class="input-group-addon"><i class="fa fa-object-group" aria-hidden="true"></i></span>
                                <input type="text" id="givenArea" value="" name="givenArea" class="form-control" placeholder="Enter Area in Sq.Ft." required> </div>
                            <div class="form-group input-group">
                                <button class="btn btn-primary" type="submit" name="submit" id="submit-calculate"> <i class="fa fa-calculator" aria-hidden="true"></i> Calculate</button>
                                <input type="hidden" name="action" value="1"> </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modalpopup" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close modal-close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Leep Pricing Estimate</h4> </div>
                <div class="modal-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Regular Price</th>
                                <th>USGBC member</th>
                            </tr>
                        </thead>
                        <tbody id="tablebody"> </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger modal-close" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>